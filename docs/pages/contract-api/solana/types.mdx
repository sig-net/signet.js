# Solana Program Types

This page documents the data types used by the Signet Solana Program.

## Signature

ECDSA signature in affine point representation, compatible with secp256k1 curve operations.

### Structure

```rust
#[derive(AnchorSerialize, AnchorDeserialize, Clone, Debug)]
pub struct Signature {
    pub big_r: AffinePoint,
    pub s: [u8; 32],
    pub recovery_id: u8,
}
```

### Fields

| Field | Type | Size | Description |
|-------|------|------|-------------|
| `big_r` | `AffinePoint` | 64 bytes | R point of the ECDSA signature |
| `s` | `[u8; 32]` | 32 bytes | s scalar of the signature |
| `recovery_id` | `u8` | 1 byte | Recovery ID (0 or 1) for public key recovery |

### Conversion to RSV Format

```typescript
// Convert to standard RSV format
const r = Buffer.from(signature.bigR.x).toString('hex');
const s = Buffer.from(signature.s).toString('hex');
const v = signature.recoveryId + 27;

const rsvSignature = { r, s, v };
```

### Usage with viem

```typescript
import { serializeSignature } from 'viem';

const serialized = serializeSignature({
  r: `0x${r}`,
  s: `0x${s}`,
  v: BigInt(v),
});
```

---

## AffinePoint

A point on the secp256k1 elliptic curve in affine coordinates.

### Structure

```rust
#[derive(AnchorSerialize, AnchorDeserialize, Clone, Debug)]
pub struct AffinePoint {
    pub x: [u8; 32],
    pub y: [u8; 32],
}
```

### Fields

| Field | Type | Size | Description |
|-------|------|------|-------------|
| `x` | `[u8; 32]` | 32 bytes | X coordinate (big-endian) |
| `y` | `[u8; 32]` | 32 bytes | Y coordinate (big-endian) |

### Conversion to Uncompressed Public Key

```typescript
// Convert to uncompressed SEC1 format (65 bytes: 0x04 || x || y)
const uncompressedPubKey = Buffer.concat([
  Buffer.from([0x04]),
  Buffer.from(affinePoint.x),
  Buffer.from(affinePoint.y),
]);
```

---

## ErrorResponse

Error information returned by the MPC network for failed signature requests.

### Structure

```rust
#[derive(AnchorSerialize, AnchorDeserialize, Clone, Debug)]
pub struct ErrorResponse {
    pub request_id: [u8; 32],
    pub error_message: String,
}
```

### Fields

| Field | Type | Description |
|-------|------|-------------|
| `request_id` | `[u8; 32]` | Identifier of the failed request |
| `error_message` | `String` | Human-readable error description |

---

## Request ID

A 32-byte identifier that uniquely identifies a signature request.

### Calculation

For `sign` instruction (uses standard ABI encoding):

```typescript
import { keccak256, encodeAbiParameters, parseAbiParameters } from 'viem';

const requestId = keccak256(
  encodeAbiParameters(
    parseAbiParameters('string, bytes, string, uint32, string, string, string, string'),
    [sender, payload, path, keyVersion, chainId, algo, dest, params]
  )
);
```

For `sign_bidirectional` instruction (uses ABI-packed encoding):

```typescript
import { keccak256, encodePacked } from 'viem';

const requestId = keccak256(
  encodePacked(
    ['string', 'bytes', 'string', 'uint32', 'string', 'string', 'string', 'string'],
    [sender, serializedTransaction, caip2Id, keyVersion, path, algo, dest, params]
  )
);
```

---

## Serialization Schemas

### ABI Schema

Used for `output_deserialization_schema` - defines how to decode EVM call return values.

```json
[
  {"name": "fieldName1", "type": "uint256"},
  {"name": "fieldName2", "type": "bool"},
  {"name": "fieldName3", "type": "address"},
  {"name": "fieldName4", "type": "bytes32"}
]
```

**Supported Types**:
- `uint256`, `uint128`, `uint64`, `uint32`, `uint16`, `uint8`
- `int256`, `int128`, `int64`, `int32`, `int16`, `int8`
- `bool`
- `address`
- `bytes`, `bytes32`, `bytes20`, etc.
- `string`
- `uint256[]`, `address[]`, etc. (arrays)

### Borsh Schema

Used for `respond_serialization_schema` - defines how to encode the response for Solana.

```json
[
  {"name": "output", "type": "bytes"}
]
```

**Supported Types**:
- `bool` - 1 byte (0 or 1)
- `u8`, `u16`, `u32`, `u64`, `u128` - unsigned integers (little-endian)
- `i8`, `i16`, `i32`, `i64`, `i128` - signed integers (little-endian)
- `string` - u32 length + UTF-8 bytes
- `bytes` - u32 length + raw bytes
- `[u8; N]` - fixed-size byte array

---

## TypeScript Type Definitions

### IDL Types

```typescript
import type { ChainSignaturesProject } from 'signet.js/contracts/solana';

// Signature type from IDL
type Signature = {
  bigR: {
    x: number[];  // [u8; 32]
    y: number[];  // [u8; 32]
  };
  s: number[];    // [u8; 32]
  recoveryId: number;
};

// Error response type
type ErrorResponse = {
  requestId: number[];  // [u8; 32]
  errorMessage: string;
};

// Program state type
type ProgramState = {
  admin: PublicKey;
  signatureDeposit: BN;
  chainId: string;
};
```

### Event Types

```typescript
// SignatureRequestedEvent
type SignatureRequestedEvent = {
  sender: PublicKey;
  payload: number[];  // [u8; 32]
  keyVersion: number;
  deposit: BN;
  chainId: string;
  path: string;
  algo: string;
  dest: string;
  params: string;
  feePayer: PublicKey | null;
};

// SignatureRespondedEvent
type SignatureRespondedEvent = {
  requestId: number[];  // [u8; 32]
  responder: PublicKey;
  signature: Signature;
};

// SignBidirectionalEvent
type SignBidirectionalEvent = {
  sender: PublicKey;
  serializedTransaction: number[];
  caip2Id: string;
  keyVersion: number;
  deposit: BN;
  path: string;
  algo: string;
  dest: string;
  params: string;
  programId: PublicKey;
  outputDeserializationSchema: number[];
  respondSerializationSchema: number[];
};

// RespondBidirectionalEvent
type RespondBidirectionalEvent = {
  requestId: number[];  // [u8; 32]
  responder: PublicKey;
  serializedOutput: number[];
  signature: Signature;
};
```

---

## Constants

### Magic Error Prefix

Used to indicate failed transaction in `respond_bidirectional`:

```rust
const MAGIC_ERROR_PREFIX: [u8; 4] = [0xde, 0xad, 0xbe, 0xef];
```

```typescript
const MAGIC_ERROR_PREFIX = Buffer.from([0xde, 0xad, 0xbe, 0xef]);

// Check if response indicates failure
function isErrorResponse(output: Buffer): boolean {
  return output.slice(0, 4).equals(MAGIC_ERROR_PREFIX);
}
```

### Response Path

Special derivation path used for `respond_bidirectional` signatures:

```rust
const SOLANA_RESPOND_BIDIRECTIONAL_PATH: &str = "solana response key";
```
